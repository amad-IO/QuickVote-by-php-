import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { Vote, Plus, Play, Link as LinkIcon, X, ArrowLeft, Copy, CheckCircle, Upload, Square, Trash2 } from 'lucide-react';
import { createPoll, getPolls, startPoll, deletePoll } from '../../services/api';
import DashboardOne from './DashboardOne';

interface Candidate {
    id: string;
    name: string;
    description: string;
    photo?: string;
}

interface Poll {
    id: string;
    title: string;
    candidates: Candidate[];
    isActive: boolean;
    createdBy: string;
    createdAt: string;
    votes: Record<string, number>;
}

export default function DashboardTwo() {
    const [polls, setPolls] = useState<Poll[]>([]);
    const [showAddCandidate, setShowAddCandidate] = useState(false);
    const [candidateName, setCandidateName] = useState('');
    const [candidateDesc, setCandidateDesc] = useState('');
    const [candidatePhoto, setCandidatePhoto] = useState('');
    const [pollTitle, setPollTitle] = useState('');
    const [currentCandidates, setCurrentCandidates] = useState<Candidate[]>([]);
    const [generatedLink, setGeneratedLink] = useState('');
    const [showLinkModal, setShowLinkModal] = useState(false);
    const [copied, setCopied] = useState(false);
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const navigate = useNavigate();

    useEffect(() => {
        loadPolls();
    }, []);

    const loadPolls = async () => {
        try {
            const data = await getPolls();
            setPolls(data);
        } catch (error) {
            console.error('Error loading polls:', error);
            // Fallback to localStorage if API fails
            const savedPolls = JSON.parse(localStorage.getItem('polls') || '[]');
            setPolls(savedPolls);
        }
    };

    const handleAddCandidate = () => {
        if (!candidateName.trim()) return;

        const newCandidate: Candidate = {
            id: Date.now().toString(),
            name: candidateName,
            description: candidateDesc,
            photo: candidatePhoto
        };

        setCurrentCandidates([...currentCandidates, newCandidate]);
        setCandidateName('');
        setCandidateDesc('');
        setCandidatePhoto('');
        setShowAddCandidate(false);
    };

    const handleRemoveCandidate = (id: string) => {
        setCurrentCandidates(currentCandidates.filter(c => c.id !== id));
    };

    // Compress image if larger than 5MB
    const compressImage = async (base64String: string, maxSizeMB: number = 5): Promise<string> => {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d')!;

                // Calculate size in MB
                const sizeInMB = (base64String.length * 0.75) / (1024 * 1024);

                console.log(`üìä Original image size: ${sizeInMB.toFixed(2)} MB`);

                if (sizeInMB <= maxSizeMB) {
                    console.log('‚úÖ Image size OK, no compression needed');
                    resolve(base64String);
                    return;
                }

                // Calculate compression ratio
                let quality = 0.7;
                let maxWidth = 1200;
                let maxHeight = 1200;

                // More aggressive compression for very large images
                if (sizeInMB > 10) {
                    quality = 0.5;
                    maxWidth = 800;
                    maxHeight = 800;
                }

                // Calculate new dimensions while maintaining aspect ratio
                let width = img.width;
                let height = img.height;

                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = width * ratio;
                    height = height * ratio;
                }

                canvas.width = width;
                canvas.height = height;

                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);

                const compressedSizeMB = (compressedBase64.length * 0.75) / (1024 * 1024);
                console.log(`‚úÖ Compressed image size: ${compressedSizeMB.toFixed(2)} MB`);
                console.log(`üìâ Compression ratio: ${((1 - compressedSizeMB / sizeInMB) * 100).toFixed(1)}%`);

                resolve(compressedBase64);
            };
            img.src = base64String;
        });
    };


    const handleSavePoll = async () => {
        console.log('üîµ handleSavePoll called');
        console.log('üìù Poll Title:', pollTitle);
        console.log('üë• Candidates:', currentCandidates);
        console.log('üë§ Current User:', currentUser);

        if (!pollTitle.trim() || currentCandidates.length < 2) {
            console.log('‚ùå Validation failed');
            alert('Masukkan judul polling dan minimal 2 kandidat');
            return;
        }

        try {
            console.log('üóúÔ∏è Compressing candidate photos...');

            // Compress all candidate photos
            const candidatesWithCompressedPhotos = await Promise.all(
                currentCandidates.map(async (candidate) => {
                    if (candidate.photo) {
                        const compressedPhoto = await compressImage(candidate.photo, 5);
                        return {
                            ...candidate,
                            photo: compressedPhoto
                        };
                    }
                    return candidate;
                })
            );

            console.log('‚úÖ Photos compressed successfully');

            const newPoll: Poll = {
                id: Date.now().toString(),
                title: pollTitle,
                candidates: candidatesWithCompressedPhotos, // Use compressed photos
                isActive: false,
                createdBy: currentUser?.id || 'anonymous',
                createdAt: new Date().toISOString(),
                votes: {}
            };

            console.log('üì¶ New Poll (with compressed photos):', newPoll);

            const savedPolls = JSON.parse(localStorage.getItem('polls') || '[]');
            console.log('üìö Existing Polls:', savedPolls);

            savedPolls.push(newPoll);

            // Save to localStorage (with compressed photos)
            localStorage.setItem('polls', JSON.stringify(savedPolls));

            console.log('‚úÖ Poll saved to localStorage (with compressed photos)');

            // Success feedback
            alert('Voting berhasil disimpan!\n\nFoto telah dikompresi untuk menghemat ruang.');

            setPollTitle('');
            setCurrentCandidates([]);
            loadPolls();

            console.log('‚úÖ State reset and polls reloaded');
        } catch (error) {
            console.error('‚ùå Error in handleSavePoll:', error);

            if (error instanceof DOMException && error.name === 'QuotaExceededError') {
                alert('Error: Penyimpanan penuh!\n\nBahkan setelah kompresi, foto masih terlalu besar.\nHapus beberapa voting lama atau gunakan foto yang lebih kecil.');
            } else {
                alert('Terjadi error saat menyimpan voting: ' + error);
            }
        }
    };

    const handleStartVoting = (pollId: string) => {
        const savedPolls = JSON.parse(localStorage.getItem('polls') || '[]');
        const poll = savedPolls.find((p: Poll) => p.id === pollId);

        if (poll) {
            poll.isActive = true;
            localStorage.setItem('polls', JSON.stringify(savedPolls));

            // Generate link
            const link = `${window.location.origin}/vote/${pollId}`;
            setGeneratedLink(link);
            setShowLinkModal(true);
            loadPolls();
        }
    };

    const handleCopyLink = () => {
        navigator.clipboard.writeText(generatedLink);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const handleStopVoting = (pollId: string) => {
        const savedPolls = JSON.parse(localStorage.getItem('polls') || '[]');
        const poll = savedPolls.find((p: Poll) => p.id === pollId);

        if (poll) {
            poll.isActive = false;
            localStorage.setItem('polls', JSON.stringify(savedPolls));
            loadPolls();
        }
    };

    const handleDeletePoll = (pollId: string) => {
        if (confirm('Apakah Anda yakin ingin menghapus voting ini?')) {
            const savedPolls = JSON.parse(localStorage.getItem('polls') || '[]');
            const updatedPolls = savedPolls.filter((p: Poll) => p.id !== pollId);
            localStorage.setItem('polls', JSON.stringify(updatedPolls));
            loadPolls();
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-b from-[#1a1d35] to-[#0f1123] text-white">
            {/* Header */}
            <header className="border-b border-gray-800 sticky top-0 bg-[#1a1d35]/95 backdrop-blur-md z-40">
                <div className="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                    <div className="flex items-center gap-2 sm:gap-4">
                        <button
                            onClick={() => navigate('/dashboard/one')}
                            className="text-gray-400 hover:text-white transition-colors p-2 hover:bg-gray-800/50 rounded-lg"
                        >
                            <ArrowLeft className="w-5 h-5" />
                        </button>
                        <div className="flex items-center gap-2">
                            <Vote className="w-5 h-5 sm:w-6 sm:h-6 text-indigo-500" />
                            <span className="text-base sm:text-xl font-semibold">Kelola Voting</span>
                        </div>
                    </div>
                </div>
            </header>

            <div className="container mx-auto px-4 sm:px-6 py-8 sm:py-12">
                <div className="max-w-6xl mx-auto">
                    {/* Create New Poll Section */}
                    <div className="bg-[#1f2342] border border-indigo-900/30 rounded-xl sm:rounded-2xl p-4 sm:p-6 md:p-8 mb-6 sm:mb-8">
                        <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Buat Voting Baru</h2>

                        {/* Poll Title */}
                        <div className="mb-5 sm:mb-6">
                            <label className="text-sm font-medium text-gray-400 block mb-2">Judul Voting</label>
                            <input
                                type="text"
                                value={pollTitle}
                                onChange={(e) => setPollTitle(e.target.value)}
                                placeholder="Contoh: Pemilihan Ketua OSIS 2024"
                                className="w-full bg-[#0f1123] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all duration-200"
                            />
                        </div>

                        {/* Candidates List */}
                        <div className="mb-5 sm:mb-6">
                            <div className="flex justify-between items-center mb-4">
                                <label className="text-sm font-medium text-gray-400">Kandidat ({currentCandidates.length})</label>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                                {currentCandidates.map((candidate) => (
                                    <div
                                        key={candidate.id}
                                        className="bg-[#0f1123] border border-gray-700 rounded-lg overflow-hidden relative group"
                                    >
                                        <button
                                            onClick={() => handleRemoveCandidate(candidate.id)}
                                            className="absolute top-2 right-2 z-10 bg-red-600 hover:bg-red-700 rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity"
                                        >
                                            <X className="w-4 h-4" />
                                        </button>
                                        {candidate.photo ? (
                                            <img
                                                src={candidate.photo}
                                                alt={candidate.name}
                                                className="w-full h-48 object-cover"
                                            />
                                        ) : (
                                            <div className="w-full h-48 bg-gray-800 flex items-center justify-center">
                                                <Upload className="w-12 h-12 text-gray-600" />
                                            </div>
                                        )}
                                        <div className="p-4">
                                            <div className="mb-1">{candidate.name}</div>
                                            <div className="text-sm text-gray-400 line-clamp-2">{candidate.description}</div>
                                        </div>
                                    </div>
                                ))}

                                {/* Add Candidate Card */}
                                <button
                                    onClick={() => setShowAddCandidate(true)}
                                    className="border-2 border-dashed border-gray-700 hover:border-indigo-500 hover:shadow-lg hover:shadow-indigo-500/20 rounded-lg p-6 sm:p-8 flex flex-col items-center justify-center gap-4 min-h-[280px] sm:min-h-[320px] transition-all duration-300 group"
                                >
                                    <div className="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-indigo-600/20 group-hover:bg-indigo-600/30 group-hover:scale-110 flex items-center justify-center transition-all duration-300">
                                        <Plus className="w-7 h-7 sm:w-8 sm:h-8 text-indigo-500" />
                                    </div>
                                    <div className="text-center">
                                        <div className="mb-1 font-medium">Tambah Kandidat</div>
                                        <div className="text-sm text-gray-400">Klik untuk menambahkan kandidat baru</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        {/* Save Button */}
                        {currentCandidates.length >= 2 && (
                            <button
                                type="button"
                                onClick={async () => {
                                    console.log('üñ±Ô∏è Button clicked!');
                                    await handleSavePoll();
                                }}
                                className="w-full bg-green-600 hover:bg-opacity-90 hover:shadow-lg hover:shadow-green-500/50 py-3 rounded-lg transition-all duration-300 font-medium text-white hover:text-white cursor-pointer"
                            >
                                Simpan Voting
                            </button>
                        )}
                        {currentCandidates.length < 2 && (
                            <div className="text-gray-400 text-sm text-center py-2">
                                Tambahkan minimal 2 kandidat untuk menyimpan voting
                            </div>
                        )}
                    </div>

                    {/* Existing Polls */}
                    <div>
                        <h2 className="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Daftar Voting</h2>

                        {polls.length === 0 ? (
                            <div className="bg-[#1f2342] border border-indigo-900/30 rounded-xl sm:rounded-2xl p-8 sm:p-12 text-center text-gray-400">
                                Belum ada voting yang dibuat
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {polls.map((poll) => (
                                    <div
                                        key={poll.id}
                                        className="bg-[#1f2342] border border-indigo-900/30 rounded-xl p-4 sm:p-6 hover:border-indigo-500/50 transition-all duration-300"
                                    >
                                        <div className="mb-4">
                                            <h3 className="text-lg sm:text-xl font-semibold mb-2">{poll.title}</h3>
                                            <div className="text-sm text-gray-400">
                                                {poll.candidates.length} kandidat ‚Ä¢ {' '}
                                                {poll.isActive ? (
                                                    <span className="text-green-400">‚óè Aktif</span>
                                                ) : (
                                                    <span className="text-gray-500">‚óã Belum Aktif</span>
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                                            <label className="text-sm font-medium text-gray-400">Kandidat ({poll.candidates.length})</label>
                                            <div className="flex flex-wrap gap-2">
                                                {!poll.isActive && (
                                                    <button
                                                        onClick={() => handleStartVoting(poll.id)}
                                                        className="flex items-center gap-2 bg-indigo-600 hover:bg-opacity-90 hover:shadow-lg hover:shadow-indigo-500/50 px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium"
                                                    >
                                                        <Play className="w-4 h-4" />
                                                        Mulai Voting
                                                    </button>
                                                )}
                                                {poll.isActive && (
                                                    <>
                                                        <button
                                                            onClick={() => {
                                                                setGeneratedLink(`${window.location.origin}/vote/${poll.id}`);
                                                                setShowLinkModal(true);
                                                            }}
                                                            className="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 hover:shadow-lg px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium"
                                                        >
                                                            <LinkIcon className="w-4 h-4" />
                                                            Lihat Link
                                                        </button>
                                                        <button
                                                            onClick={() => handleStopVoting(poll.id)}
                                                            className="flex items-center gap-2 bg-red-600 hover:bg-opacity-90 hover:shadow-lg hover:shadow-red-500/50 px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium"
                                                        >
                                                            <Square className="w-4 h-4" />
                                                            Stop
                                                        </button>
                                                    </>
                                                )}
                                                <button
                                                    onClick={() => handleDeletePoll(poll.id)}
                                                    className="flex items-center gap-2 bg-red-600 hover:bg-opacity-90 hover:shadow-lg hover:shadow-red-500/50 px-4 py-2 rounded-lg transition-all duration-300 text-sm font-medium"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                    Hapus
                                                </button>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                            {poll.candidates.map((candidate) => (
                                                <div
                                                    key={candidate.id}
                                                    className="bg-[#0f1123] border border-gray-700 rounded-lg p-4 flex items-center gap-4"
                                                >
                                                    {candidate.photo ? (
                                                        <img
                                                            src={candidate.photo}
                                                            alt={candidate.name}
                                                            className="w-20 h-20 object-cover rounded-lg flex-shrink-0"
                                                        />
                                                    ) : (
                                                        <div className="w-20 h-20 bg-gray-800 rounded-lg flex-shrink-0 flex items-center justify-center">
                                                            <Upload className="w-8 h-8 text-gray-600" />
                                                        </div>
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-xs text-indigo-400 uppercase tracking-wide mb-1">Kandidat</div>
                                                        <div className="mb-1 truncate">{candidate.name}</div>
                                                        {candidate.description && (
                                                            <div className="text-sm text-gray-400 line-clamp-1">{candidate.description}</div>
                                                        )}
                                                        {poll.isActive && (
                                                            <div className="text-sm text-indigo-400 mt-2">
                                                                {poll.votes[candidate.id] || 0} suara
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* Add Candidate Modal */}
            {showAddCandidate && (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
                    <div className="bg-[#1a1d35] border border-gray-800 rounded-2xl p-8 max-w-md w-full">
                        <h3 className="text-2xl mb-6">Tambah Kandidat</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="text-sm text-gray-400 block mb-2">Nama Kandidat</label>
                                <input
                                    type="text"
                                    value={candidateName}
                                    onChange={(e) => setCandidateName(e.target.value)}
                                    placeholder="Nama lengkap kandidat"
                                    className="w-full bg-[#0f1123] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition"
                                    autoFocus
                                />
                            </div>
                            <div>
                                <label className="text-sm text-gray-400 block mb-2">Deskripsi (Opsional)</label>
                                <textarea
                                    value={candidateDesc}
                                    onChange={(e) => setCandidateDesc(e.target.value)}
                                    placeholder="Visi misi atau deskripsi singkat"
                                    className="w-full bg-[#0f1123] border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 transition h-24 resize-none"
                                />
                            </div>
                            <div>
                                <label className="text-sm text-gray-400 block mb-2">Foto (Opsional)</label>
                                <div className="space-y-3">
                                    <label className="flex items-center justify-center gap-2 w-full bg-[#0f1123] border border-gray-700 hover:border-indigo-500 rounded-lg px-4 py-3 text-gray-400 cursor-pointer transition">
                                        <Upload className="w-4 h-4" />
                                        <span>Pilih Foto</span>
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={(e) => {
                                                const file = e.target.files?.[0];
                                                if (file) {
                                                    const reader = new FileReader();
                                                    reader.onloadend = () => {
                                                        setCandidatePhoto(reader.result as string);
                                                    };
                                                    reader.readAsDataURL(file);
                                                }
                                            }}
                                            className="hidden"
                                        />
                                    </label>
                                    {candidatePhoto && (
                                        <div className="relative">
                                            <img
                                                src={candidatePhoto}
                                                alt="Preview"
                                                className="w-full h-32 object-cover rounded-lg border border-gray-700"
                                            />
                                            <button
                                                onClick={() => setCandidatePhoto('')}
                                                className="absolute top-2 right-2 bg-red-600 hover:bg-red-700 rounded-full p-1 transition"
                                            >
                                                <X className="w-4 h-4" />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        setShowAddCandidate(false);
                                        setCandidateName('');
                                        setCandidateDesc('');
                                        setCandidatePhoto('');
                                    }}
                                    className="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition"
                                >
                                    Batal
                                </button>
                                <button
                                    onClick={handleAddCandidate}
                                    className="flex-1 bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg transition"
                                >
                                    Tambahkan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Link Modal */}
            {showLinkModal && (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
                    <div className="bg-[#1a1d35] border border-gray-800 rounded-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-green-600/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <CheckCircle className="w-8 h-8 text-green-400" />
                            </div>
                            <h3 className="text-2xl mb-2">Link Voting Berhasil Dibuat!</h3>
                            <p className="text-gray-400">Bagikan link ini kepada pemilih</p>
                        </div>

                        <div className="bg-[#0f1123] border border-gray-700 rounded-lg p-4 mb-4 relative">
                            <div className="text-sm text-gray-400 mb-2">Link Voting:</div>
                            <div className="text-indigo-400 break-all pr-10">{generatedLink}</div>
                            <button
                                onClick={handleCopyLink}
                                className="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 p-2 rounded-lg transition"
                                title="Salin Link"
                            >
                                {copied ? (
                                    <CheckCircle className="w-5 h-5 text-green-400" />
                                ) : (
                                    <Copy className="w-5 h-5 text-gray-400" />
                                )}
                            </button>
                        </div>

                        <div className="flex gap-3">
                            <button
                                onClick={() => setShowLinkModal(false)}
                                className="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg transition"
                            >
                                Tutup
                            </button>
                            <button
                                onClick={() => navigate(`/vote/${generatedLink.split('/vote/')[1]}`)}
                                className="flex-1 bg-indigo-600 hover:bg-indigo-700 py-3 rounded-lg transition flex items-center justify-center gap-2"
                            >
                                <Vote className="w-4 h-4" />
                                Buka Halaman Voting
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}