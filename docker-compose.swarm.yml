version: '3.8'

# Docker Swarm Stack for QuickVote
# High-scale architecture supporting millions of votes
# Deploy command: docker stack deploy -c docker-compose.swarm.yml quickvote

services:
  # ========================================
  # NGINX LOAD BALANCER
  # ========================================
  nginx:
    image: quickvote/nginx:latest
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
    networks:
      - frontend_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========================================
  # FRONTEND (REACT + NGINX)
  # ========================================
  frontend:
    image: quickvote/frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    networks:
      - frontend_net
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health" ]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s

  # ========================================
  # BACKEND (LARAVEL API)
  # ========================================
  backend:
    image: quickvote/backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    networks:
      - frontend_net
      - backend_net
      - cache_net
      - db_net
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_CONNECTION=mysql
      - DB_HOST=mysql-master
      - DB_PORT=3306
      - DB_DATABASE=quickvote
      - DB_USERNAME=quickvote
      - DB_PASSWORD=secret
      - DB_READ_HOST=mysql-replica-1,mysql-replica-2
      - REDIS_HOST=redis-cache
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - QUEUE_CONNECTION=redis
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
    deploy:
      replicas: 4
      update_config:
        parallelism: 2
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "php", "artisan", "db:show" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      - mysql-master
      - redis-cache
      - redis-queue

  # ========================================
  # QUEUE WORKERS (ASYNC VOTE PROCESSING)
  # ========================================
  queue-worker:
    image: quickvote/queue-worker:latest
    build:
      context: ./queue-worker
      dockerfile: Dockerfile
    networks:
      - backend_net
      - cache_net
      - db_net
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_CONNECTION=mysql
      - DB_HOST=mysql-master
      - DB_PORT=3306
      - DB_DATABASE=quickvote
      - DB_USERNAME=quickvote
      - DB_PASSWORD=secret
      - REDIS_HOST=redis-queue
      - REDIS_PORT=6379
      - QUEUE_CONNECTION=redis
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "ps", "aux", "|", "grep", "-q", "[a]rtisan queue:work" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - mysql-master
      - redis-queue

  # ========================================
  # REDIS CACHE (SESSION + DATA CACHE)
  # ========================================
  redis-cache:
    image: redis:7-alpine
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - ./redis/redis-cache.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - cache_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.redis == cache
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # ========================================
  # REDIS QUEUE (VOTE QUEUE WITH PERSISTENCE)
  # ========================================
  redis-queue:
    image: redis:7-alpine
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - ./redis/redis-queue.conf:/usr/local/etc/redis/redis.conf:ro
      - redis_queue_data:/data
    networks:
      - cache_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.redis == queue
      resources:
        limits:
          cpus: '1'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # ========================================
  # MYSQL MASTER (WRITE OPERATIONS)
  # ========================================
  mysql-master:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./database/mysql-master.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - mysql_master_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: quickvote
      MYSQL_USER: quickvote
      MYSQL_PASSWORD: secret
    networks:
      - db_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == master
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psecret" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ========================================
  # MYSQL REPLICA 1 (READ OPERATIONS)
  # ========================================
  mysql-replica-1:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./database/mysql-replica.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - mysql_replica1_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: quickvote
      MYSQL_USER: quickvote
      MYSQL_PASSWORD: secret
    networks:
      - db_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == replica
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psecret" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - mysql-master

  # ========================================
  # MYSQL REPLICA 2 (READ OPERATIONS)
  # ========================================
  mysql-replica-2:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./database/mysql-replica.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - mysql_replica2_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: quickvote
      MYSQL_USER: quickvote
      MYSQL_PASSWORD: secret
    networks:
      - db_net
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.database == replica
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-psecret" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      - mysql-master

# ========================================
# NETWORKS
# ========================================
networks:
  frontend_net:
    driver: overlay
    attachable: true
  backend_net:
    driver: overlay
    internal: true
  cache_net:
    driver: overlay
    internal: true
  db_net:
    driver: overlay
    internal: true

# ========================================
# VOLUMES
# ========================================
volumes:
  mysql_master_data:
    driver: local
  mysql_replica1_data:
    driver: local
  mysql_replica2_data:
    driver: local
  redis_queue_data:
    driver: local
